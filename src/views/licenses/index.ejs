<% layout('layout') %>

<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <img src="<%= user.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.name) %>" 
                             alt="<%= user.name %>" class="rounded-circle" width="60" height="60">
                        <h6 class="mt-2 mb-0"><%= user.name %></h6>
                        <small class="text-muted"><%= user.email %></small>
                    </div>
                    
                    <nav class="nav flex-column">
                        <a class="nav-link" href="/dashboard">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Dashboard
                        </a>
                        <a class="nav-link active" href="/licenses">
                            <i class="fas fa-key me-2"></i>
                            My Licenses
                        </a>
                        <a class="nav-link" href="/dashboard/analytics">
                            <i class="fas fa-chart-bar me-2"></i>
                            Analytics
                        </a>
                        <a class="nav-link" href="/dashboard/billing">
                            <i class="fas fa-credit-card me-2"></i>
                            Billing
                        </a>
                        <a class="nav-link" href="/profile">
                            <i class="fas fa-user me-2"></i>
                            Profile
                        </a>
                        <a class="nav-link" href="/support">
                            <i class="fas fa-headset me-2"></i>
                            Support
                        </a>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">My Licenses</h2>
                    <p class="text-muted mb-0">Manage and monitor your license keys</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLicenseModal">
                    <i class="fas fa-plus me-2"></i>
                    Add License
                </button>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-success">
                                <i class="fas fa-check-circle fs-1"></i>
                            </div>
                            <h4 class="mt-2 mb-0"><%= licenses.filter(l => l.status === 'active').length %></h4>
                            <p class="text-muted mb-0">Active Licenses</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-warning">
                                <i class="fas fa-exclamation-triangle fs-1"></i>
                            </div>
                            <h4 class="mt-2 mb-0"><%= licenses.filter(l => l.status === 'expired').length %></h4>
                            <p class="text-muted mb-0">Expired Licenses</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-info">
                                <i class="fas fa-chart-line fs-1"></i>
                            </div>
                            <h4 class="mt-2 mb-0"><%= licenses.reduce((sum, l) => sum + l.usage.totalValidations, 0) %></h4>
                            <p class="text-muted mb-0">Total Validations</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-primary">
                                <i class="fas fa-dollar-sign fs-1"></i>
                            </div>
                            <h4 class="mt-2 mb-0">$<%= licenses.reduce((sum, l) => sum + l.price, 0) %></h4>
                            <p class="text-muted mb-0">Total Spent</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Licenses Table -->
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-0">License Overview</h5>
                        </div>
                        <div class="col-auto">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search licenses..." id="searchInput">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <% if (licenses.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Application</th>
                                        <th>License Key</th>
                                        <th>Status</th>
                                        <th>Plan</th>
                                        <th>Expires</th>
                                        <th>Usage</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% licenses.forEach(function(license) { %>
                                        <tr>
                                            <td>
                                                <div>
                                                    <h6 class="mb-0"><%= license.applicationName %></h6>
                                                    <small class="text-muted">$<%= license.price %>/<%= license.plan %></small>
                                                </div>
                                            </td>
                                            <td>
                                                <code class="text-primary"><%= license.key %></code>
                                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('<%= license.key %>')">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </td>
                                            <td>
                                                <% if (license.status === 'active') { %>
                                                    <span class="badge bg-success">Active</span>
                                                <% } else if (license.status === 'expired') { %>
                                                    <span class="badge bg-warning">Expired</span>
                                                <% } else { %>
                                                    <span class="badge bg-danger">Suspended</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary"><%= license.plan %></span>
                                            </td>
                                            <td>
                                                <div>
                                                    <%= new Date(license.expiresAt).toLocaleDateString() %>
                                                    <% if (license.status === 'active') { %>
                                                        <% const daysLeft = Math.ceil((new Date(license.expiresAt) - new Date()) / (1000 * 60 * 60 * 24)); %>
                                                        <% if (daysLeft <= 7) { %>
                                                            <br><small class="text-warning">Expires in <%= daysLeft %> days</small>
                                                        <% } %>
                                                    <% } %>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong><%= license.usage.totalValidations %></strong>
                                                    <% if (license.usage.maxValidations > 0) { %>
                                                        / <%= license.usage.maxValidations %>
                                                    <% } else { %>
                                                        <small class="text-muted">(unlimited)</small>
                                                    <% } %>
                                                    <br>
                                                    <small class="text-muted">Last: <%= new Date(license.usage.lastValidated).toLocaleDateString() %></small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="/licenses/<%= license.id %>" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <button class="btn btn-sm btn-outline-success" onclick="validateLicense('<%= license.id %>')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info" onclick="downloadLicense('<%= license.id %>')">
                                                        <i class="fas fa-download"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="text-center py-5">
                            <i class="fas fa-key fs-1 text-muted mb-3"></i>
                            <h5 class="text-muted">No licenses found</h5>
                            <p class="text-muted">You don't have any licenses yet. Get started by adding your first license.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLicenseModal">
                                <i class="fas fa-plus me-2"></i>
                                Add Your First License
                            </button>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add License Modal -->
<div class="modal fade" id="addLicenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New License</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/licenses" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="applicationName" class="form-label">Application Name</label>
                        <input type="text" class="form-control" id="applicationName" name="applicationName" required>
                    </div>
                    <div class="mb-3">
                        <label for="plan" class="form-label">Plan</label>
                        <select class="form-select" id="plan" name="plan" required>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                            <option value="lifetime">Lifetime</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Price</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="features" class="form-label">Features (one per line)</label>
                        <textarea class="form-control" id="features" name="features" rows="3" placeholder="Real-time analytics&#10;Custom dashboards&#10;API access"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add License</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-success border-0';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    License key copied to clipboard!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        setTimeout(() => toast.remove(), 3000);
    });
}

// Validate license function
function validateLicense(licenseId) {
    fetch(`/licenses/${licenseId}/validate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            hardwareId: 'mock-hardware-id'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('License is valid and active!');
        } else {
            alert('License validation failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error validating license');
    });
}

// Download license function
function downloadLicense(licenseId) {
    window.open(`/licenses/${licenseId}/download`, '_blank');
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});
</script>
